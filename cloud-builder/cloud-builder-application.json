{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation Template for IoT Core Setup",
    "Resources": {
        "MyIoTPolicy": {
            "Type": "AWS::IoT::Policy",
            "Properties": {
                "PolicyName": "jimm_monitoring_iot_policy_0.0.1",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "iot:Connect",
                            "Resource": "arn:aws:iot:eu-central-1:073801343530:client/basicPubSub"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "iot:Publish",
                            "Resource": "arn:aws:iot:eu-central-1:073801343530:topic/sdk/test/python"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "iot:Subscribe",
                            "Resource": "arn:aws:iot:eu-central-1:073801343530:topic/device/9/ack"
                        }
                    ]
                }
            }
        },
        "MyIoTTopicRule": {
            "Type": "AWS::IoT::TopicRule",
            "Properties": {
                "RuleName": "WriteToSQSRule",
                "TopicRulePayload": {
                    "Sql": "SELECT * FROM 'sdk/test/python'",
                    "Actions": [
                        {
                            "Sqs": {
                                "RoleArn": "arn:aws:iam::073801343530:role/jimm-monitoring-data-acquisition-pipeline-MyIoTRole-rDZVLir6OTzN",
                                "QueueUrl": "https://sqs.eu-central-1.amazonaws.com/073801343530/MyIoTMessagesQueue",
                                "UseBase64": true
                            }
                        }
                    ],
                    "ErrorAction": {
                        "CloudwatchLogs": {
                            "RoleArn": "arn:aws:iam::073801343530:role/service-role/write_logs_from_iot_core_rule",
                            "LogGroupName": "not_rule_log",
                            "BatchMode": false
                        }
                    }
                }
            }
        },
        "MyIoTRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "jimm-monitoring-data-acquisition-pipeline-MyIoTRole-rDZVLir6OTzN",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "iot.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "MaxSessionDuration": 3600,
                "Tags": [
                    {
                        "Key": "version",
                        "Value": "0.1.0"
                    }
                ],
                "Policies": [
                    {
                        "PolicyName": "IoTToSQSPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "sqs:SendMessage",
                                    "Resource": "arn:aws:sqs:eu-central-1:073801343530:MyIoTMessagesQueue"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "MyTimestreamDatabase": {
            "Type": "AWS::Timestream::Database",
            "Properties": {
                "DatabaseName": "MyTimestreamDatabase"
            }
        },
        "MyTimestreamTable": {
            "Type": "AWS::Timestream::Table",
            "Properties": {
                "DatabaseName": {
                    "Ref": "MyTimestreamDatabase"
                },
                "TableName": "MyTimestreamTable",
                "RetentionProperties": {
                    "MemoryStoreRetentionPeriodInHours": "24",
                    "MagneticStoreRetentionPeriodInDays": "7"
                }
            }
        },
        "MyLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
              "FunctionName": "jimm-monitoring-data-acquisition--MyLambdaFunction-Iv5dUrV3FOQq",
              "Handler": "sqs_lambda_function.handler",
              "Role": "arn:aws:iam::073801343530:role/jimm-monitoring-data-acqui-MySQSLambdaExecutionRole-KfSzjnol3KwH",
              "Runtime": "python3.8",
              "Code": {
                "S3Bucket": "awslambda-eu-cent-1-tasks",
                "S3Key": "snapshots/073801343530/jimm-monitoring-data-acquisition--MyLambdaFunction-Iv5dUrV3FOQq-f881c6da-ca4b-443f-b763-70e579de5da0"
              },
              "Timeout": 3,
              "MemorySize": 128,
              "Environment": {
                "Variables": {
                  "TIMESTREAM_DATABASE": "MyTimestreamDatabase",
                  "TIMESTREAM_TABLE": "MyTimestreamTable"
                }
              },
              "TracingConfig": {
                "Mode": "PassThrough"
              },
              "PackageType": "Zip",
              "Architectures": [
                "x86_64"
              ],
              "EphemeralStorage": {
                "Size": 512
              },
              "LoggingConfig": {
                "LogFormat": "Text",
                "LogGroup": "/aws/lambda/jimm-monitoring-data-acquisition--MyLambdaFunction-Iv5dUrV3FOQq"
              }
            }
          },
        "MySQSLambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "LambdaSQSTimestreamPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:ReceiveMessage",
                                        "sqs:DeleteMessage",
                                        "sqs:GetQueueAttributes"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "MySQSQueue",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "timestream:WriteRecords",
                                        "timestream:DescribeEndpoints",
                                        "timestream:ListTables"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "iot:Publish",
                                    "Resource": [
                                        "arn:aws:iot:eu-central-1:073801343530:topic/device/*/ack"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "LambdaLoggingPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "MyEventSourceMapping": {
            "Type": "AWS::Lambda::EventSourceMapping",
            "Properties": {
                "EventSourceArn": {
                    "Fn::GetAtt": [
                        "MySQSQueue",
                        "Arn"
                    ]
                },
                "FunctionName": {
                    "Ref": "MyLambdaFunction"
                },
                "BatchSize": 10
            }
        },
        "MySQSQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": "MyIoTMessagesQueue",
                "VisibilityTimeout": 300
            }
        }
    }
}